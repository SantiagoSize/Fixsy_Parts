// ðŸ§¹ FIXSY CLEANUP: organised structure, no logic changes
import React from "react";
import { useAuth } from "../../context/AuthContext";
import { DashContext, DashKey } from "../DashboardLayout";
import logo from "../../assets/SoloLogoF_White.png";

export default function Sidebar({ role, onLogout }: { role: 'Admin' | 'Soporte'; onLogout: () => void }) {
  const { user } = useAuth();
  const ctx = React.useContext(DashContext);
  if (!ctx) return null;
  const { key, setKey } = ctx;

  const initials = (user?.nombre || 'U')[0]?.toUpperCase();

  // Calcular no leÃ­dos desde mailbox local
  const unread = React.useMemo(() => {
    try {
      const raw = localStorage.getItem('fixsy_mailbox');
      const list = raw ? JSON.parse(raw) as any[] : [];
      return user ? list.filter(m => m.to?.toLowerCase() === user.email.toLowerCase() && !m.read && !m.deleted && !m.archived).length : 0;
    } catch { return 0; }
  }, [user?.email]);

  const badge = (n?: number) => (n && n > 0) ? (n > 99 ? '99+' : String(n)) : '';

  const adminMenu: { key: DashKey; label: string; icon: string; badge?: string }[] = [
  { key: 'home', label: 'Inicio', icon: "\uD83C\uDFE0" },
  { key: 'inbox', label: 'Bandeja de entrada', icon: "\uD83D\uDCE5", badge: badge(unread) },
  { key: 'inventory', label: 'Inventario', icon: "\uD83D\uDCE6" },
  { key: 'products', label: 'Productos', icon: "\uD83D\uDED2" },
  { key: 'users', label: 'Usuarios', icon: "\uD83D\uDC65" },
  { key: 'profile', label: 'Perfil', icon: "\uD83D\uDC64" },
];
  const supportMenu: { key: DashKey; label: string; icon: string; badge?: string }[] = [
  { key: 'home', label: 'Inicio', icon: "\uD83C\uDFE0" },
  { key: 'inbox', label: 'Bandeja de entrada', icon: "\uD83D\uDCE5", badge: badge(unread) },
  { key: 'search', label: 'Buscar usuarios', icon: "\uD83D\uDD0E" },
  { key: 'purchases', label: 'Compras', icon: "\uD83E\uDDFE" },
  { key: 'stock', label: 'Stock', icon: "\uD83C\uDFF7" },
  { key: 'profile', label: 'Perfil', icon: "\uD83D\uDC64" },
];
  const menu = role === 'Admin' ? adminMenu : supportMenu;

  return (
    <div style={{ display: 'flex', flexDirection: 'column', height: '100%' }}>
      <div className="fxdash__brand">
        <div className="fxdash__logo"><img src={logo} alt="Fixsy" /></div>
        <div className="fxdash__brandTitle">Fixsy Parts</div>
        <div className="fxdash__brandSubtitle">{role === 'Admin' ? 'AdministraciÃ³n' : 'Soporte TÃ©cnico'}</div>
      </div>

      <div className="fxdash__user">
        {user?.nombre ? (
          user?.profilePic ? (
            <img src={(user as any).profilePic} alt="Avatar" style={{ width: 64, height: 64, borderRadius: '50%', objectFit: 'cover' }} />
          ) : (
            <div className="fxdash__avatar" aria-label="Avatar">{initials}</div>
          )
        ) : (
          <div className="fxdash__avatar" aria-label="Avatar">U</div>
        )}
        <div className="fxdash__hello">Hola, <strong>{user?.nombre || 'Usuario'}</strong></div>
      </div>

      <div className="fxdash__menu" role="navigation" aria-label="Menu">
        {menu.map(m => (
          <button key={m.key} className={`fxdash__item ${key === m.key ? 'fxdash__item--active' : ''}`} onClick={() => setKey(m.key)}>
            <span style={{ fontSize: 20 }}>{m.icon}</span>
            <span>{m.label}</span>
            {m.badge && (
              <span style={{ marginLeft: 'auto', background: '#ef4444', color: '#fff', borderRadius: 999, padding: '2px 6px', fontSize: 12 }}>{m.badge}</span>
            )}
          </button>
        ))}
      </div>

      <div className="fxdash__logout">
        <button onClick={onLogout}>Cerrar sesiÃ³n</button>
      </div>
    </div>
  );
}





